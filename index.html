<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Riot Buddy Finder</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Riot Buddy Finder</h1>

        <div id="loginSection" class="section">
            <div class="form-group">
                <label for="riotId">Ваш Riot ID (наприклад, Summoner#EUW1):</label>
                <input type="text" id="riotId" placeholder="Введіть ваш Riot ID" required>
            </div>
            <div class="form-group">
                <label for="lolPlatformRegion">Ваш LoL сервер (Регіон платформи):</label>
                <select id="lolPlatformRegion">
                    <option value="euw1">EU West</option>
                    <option value="eun1">EU Nordic & East</option>
                    <option value="na1">North America</option>
                    <option value="kr">Korea</option>
                    </select>
            </div>
            <div class="form-group checkbox-group">
                <input type="checkbox" id="rememberMe">
                <label for="rememberMe">Запам'ятати мене</label>
            </div>
            <button id="loginBtn">Увійти</button>
            <p id="loginErrorMessage" class="error-message"></p>
        </div>

        <div id="dashboardSection" class="section" style="display: none;">
            <h2>Ваш профіль</h2>
            <div id="profileInfoCard" class="result-card">
                <p>Riot ID: <strong id="dashboardRiotId"></strong></p>
                <p>Рівень: <strong id="dashboardSummonerLevel"></strong></p>
                <p>Ранг (SoloQ): <strong id="dashboardSummonerRank"></strong></p>
                <p>LoL Регіон: <strong id="dashboardLolRegion"></strong></p>
                <div class="form-group">
                    <label for="profileDescription">Ваш опис:</label>
                    <textarea id="profileDescription" placeholder="Розкажіть про себе (max 250 символів)" maxlength="250"></textarea>
                    <button id="saveDescriptionBtn">Зберегти опис</button>
                    <p id="descriptionSaveMessage" class="success-message"></p>
                    <p id="descriptionErrorMessage" class="error-message"></p>
                </div>
            </div>
            <button id="startSearchBtn">Розпочати пошук союзника</button>
            <button id="logoutBtn" class="secondary-btn">Вийти</button>
        </div>

        <div id="searchSection" class="section" style="display: none;">
            <div class="tabs">
                <button class="tab-button active" data-region="euw1">EU West</button>
                <button class="tab-button" data-region="eun1">EU Nordic & East</button>
                <button class="tab-button" data-region="na1">North America</option>
                <button class="tab-button" data-region="kr">Korea</option>
                </div>

            <div class="search-list-container">
                <h2 id="currentSearchRegion">Пошук на EU West</h2>
                <div id="currentUserInQueue" class="your-spot-card">
                    <h3>Ви у черзі:</h3>
                    <p>Очікування...</p>
                </div>
                <div id="searchQueueList" class="online-users-list">
                    <p>Поки що ніхто не шукає...</p>
                </div>
            </div>
            <button id="stopSearchBtn" class="secondary-btn">Зупинити пошук</button>
        </div>

        <div id="playerProfileModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-button" id="playerProfileCloseBtn">&times;</span>
                <h2>Профіль гравця</h2>
                <div id="playerProfileDetails">
                    <p>Нікнейм: <strong id="playerProfileNickname"></strong></p>
                    <p>Ранг: <strong id="playerProfileRank"></strong></p>
                    <p>Сервер: <strong id="playerProfileServer"></strong></p>
                    <p>Черга: <strong id="playerProfileQueue"></strong></p>
                    <p>Позиція: <strong id="playerProfileLane"></strong></p>
                    <p>Опис: <span id="playerProfileDescription"></span></p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Елементи Логіну
        const loginSection = document.getElementById('loginSection');
        const riotIdInput = document.getElementById('riotId');
        const lolPlatformRegionSelect = document.getElementById('lolPlatformRegion');
        const rememberMeCheckbox = document.getElementById('rememberMe');
        const loginBtn = document.getElementById('loginBtn');
        const loginErrorMessage = document.getElementById('loginErrorMessage');

        // Елементи Особистого Кабінету
        const dashboardSection = document.getElementById('dashboardSection');
        const profileInfoCard = document.getElementById('profileInfoCard');
        const dashboardRiotId = document.getElementById('dashboardRiotId');
        const dashboardSummonerLevel = document.getElementById('dashboardSummonerLevel');
        const dashboardSummonerRank = document.getElementById('dashboardSummonerRank');
        const dashboardLolRegion = document.getElementById('dashboardLolRegion');
        const profileDescriptionInput = document.getElementById('profileDescription'); // NEW
        const saveDescriptionBtn = document.getElementById('saveDescriptionBtn');     // NEW
        const descriptionSaveMessage = document.getElementById('descriptionSaveMessage'); // NEW
        const descriptionErrorMessage = document.getElementById('descriptionErrorMessage'); // NEW
        const startSearchBtn = document.getElementById('startSearchBtn');
        const logoutBtn = document.getElementById('logoutBtn');

        // Елементи Пошуку
        const searchSection = document.getElementById('searchSection');
        const tabButtons = document.querySelectorAll('.tab-button');
        const currentSearchRegionTitle = document.getElementById('currentSearchRegion');
        const currentUserInQueueCard = document.getElementById('currentUserInQueue');
        const searchQueueList = document.getElementById('searchQueueList');
        const stopSearchBtn = document.getElementById('stopSearchBtn');

        // NEW: Елементи Детального Профілю Гравця
        const playerProfileModal = document.getElementById('playerProfileModal');
        const playerProfileCloseBtn = document.getElementById('playerProfileCloseBtn');
        const playerProfileNickname = document.getElementById('playerProfileNickname');
        const playerProfileRank = document.getElementById('playerProfileRank');
        const playerProfileServer = document.getElementById('playerProfileServer');
        const playerProfileQueue = document.getElementById('playerProfileQueue');
        const playerProfileLane = document.getElementById('playerProfileLane');
        const playerProfileDescription = document.getElementById('playerProfileDescription');


        let currentActiveRegion = 'euw1'; // Регіон, який зараз активний на вкладках
        let currentUserData = null; // Для зберігання даних поточного користувача

        const BACKEND_BASE_URL = 'http://localhost:3001'; // !!! ЗМІНІТЬ ЦЕЙ URL ПІСЛЯ РОЗГОРТАННЯ БЕКЕНДУ НА RENDER.COM !!!

        // ===============================================
        // Socket.IO Клієнт
        // ===============================================
        const socket = io(BACKEND_BASE_URL);

        socket.on('connect', () => {
            console.log('Frontend: Connected to Socket.IO server');
            updateSearchQueueUI();
        });

        socket.on('initial_queue_state', (queue) => {
            console.log('Frontend: Received initial queue state. Updating UI.');
            updateSearchQueueUI();
        });

        socket.on('queue_updated', (updatedQueue) => {
            console.log('Frontend: Received queue update event. Updating UI.');
            updateSearchQueueUI();
        });

        socket.on('disconnect', () => {
            console.log('Frontend: Disonnected from Socket.IO server');
        });

        socket.on('connect_error', (error) => {
            console.error('Frontend: Socket.IO connection error:', error);
        });


        // ===============================================
        // Функції для навігації між секціями
        // ===============================================

        function showSection(sectionId) {
            console.log(`[showSection] Attempting to show section: ${sectionId}`);

            loginSection.style.display = 'none';
            dashboardSection.style.display = 'none';
            searchSection.style.display = 'none';
            playerProfileModal.style.display = 'none'; // Ensure modal is hidden
            console.log(`[showSection] Initial states: login=${loginSection.style.display}, dashboard=${dashboardSection.style.display}, search=${searchSection.style.display}, modal=${playerProfileModal.style.display}`);


            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.setProperty('display', 'block', 'important'); // Keep !important for now
                console.log(`[showSection] Successfully set ${sectionId}.style.display to 'block!important'. Current display: ${targetSection.style.display}`);
            } else {
                console.error(`[showSection] Error: Section with ID "${sectionId}" not found!`);
            }
        }

        // ===============================================
        // Логіка Логіну
        // ===============================================

        loginBtn.addEventListener('click', async () => {
            const riotId = riotIdInput.value.trim();
            const lolPlatformRegion = lolPlatformRegionSelect.value;
            const rememberMe = rememberMeCheckbox.checked;

            loginErrorMessage.textContent = ''; // Очистити попередні помилки

            if (!riotId) {
                loginErrorMessage.textContent = 'Будь ласка, введіть ваш Riot ID.';
                return;
            }

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ riotId, lolPlatformRegion, rememberMe })
                });
                const data = await response.json();
                console.log('Received data from backend:', data);

                if (response.ok) {
                    currentUserData = data;

                    // Оновлюємо дані в особистому кабінеті
                    dashboardRiotId.textContent = data.fullRiotId;
                    dashboardSummonerLevel.textContent = data.summonerLevel;
                    dashboardSummonerRank.textContent = data.rank;
                    dashboardLolRegion.textContent = data.lolRegion.toUpperCase();
                    profileDescriptionInput.value = data.description || ''; // NEW: Set description field

                    // Зберігаємо дані у localStorage
                    if (rememberMe) {
                        localStorage.setItem('riotId', riotId);
                        localStorage.setItem('lolPlatformRegion', lolPlatformRegion);
                    } else {
                        localStorage.removeItem('riotId');
                        localStorage.removeItem('lolPlatformRegion');
                    }

                    showSection('dashboardSection');

                    // Явно встановлюємо display: block для profileInfoCard (якщо потрібно)
                    if (profileInfoCard) {
                        profileInfoCard.style.display = 'block';
                        console.log('[Login Success] profileInfoCard set to display: block.');
                    } else {
                        console.error('[Login Success] profileInfoCard element not found.');
                    }

                } else {
                    console.error('Login error:', data.error);
                    loginErrorMessage.textContent = data.error || 'Невідома помилка логіну.';
                }

            } catch (err) {
                console.error('Login network error:', err);
                loginErrorMessage.textContent = 'Помилка мережі при логіні. Перевірте підключення або спробуйте пізніше.';
            }
        });

        // ===============================================
        // NEW: Логіка збереження опису профілю
        // ===============================================
        saveDescriptionBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.puuid) {
                descriptionErrorMessage.textContent = 'Будь ласка, увійдіть, щоб зберегти опис.';
                return;
            }

            const newDescription = profileDescriptionInput.value;
            descriptionSaveMessage.textContent = '';
            descriptionErrorMessage.textContent = '';

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/profile/description`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        puuid: currentUserData.puuid,
                        description: newDescription
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    currentUserData.description = newDescription; // Update local data
                    descriptionSaveMessage.textContent = 'Опис успішно збережено!';
                    setTimeout(() => descriptionSaveMessage.textContent = '', 3000); // Clear after 3 seconds
                } else {
                    descriptionErrorMessage.textContent = data.error || 'Помилка при збереженні опису.';
                }
            } catch (error) {
                console.error('Error saving description:', error);
                descriptionErrorMessage.textContent = 'Помилка мережі при збереженні опису.';
            }
        });


        // Перевіряємо, чи користувач має бути "запам'ятований" при запуску
        async function initializeApp() {
            const storedRiotId = localStorage.getItem('riotId');
            const storedRegion = localStorage.getItem('lolPlatformRegion');
            if (storedRiotId && storedRegion) {
                riotIdInput.value = storedRiotId;
                lolPlatformRegionSelect.value = storedRegion;
                rememberMeCheckbox.checked = true;
                loginBtn.click(); // Автоматично спробувати логін з збереженими даними
            } else {
                showSection('loginSection');
            }
        }

        initializeApp();

        // ===============================================
        // Логіка Особистого Кабінету
        // ===============================================

        startSearchBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.puuid) {
                console.error("No current user data available or PUUID missing for search.");
                loginErrorMessage.textContent = 'Будь ласка, увійдіть, щоб розпочати пошук.';
                showSection('loginSection');
                return;
            }

            // For now, let's pass dummy queueType and lane. We will add actual selection in the next step.
            const dummyQueueType = 'Solo/Duo'; // Placeholder
            const dummyLane = 'Any';           // Placeholder

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/start-search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        puuid: currentUserData.puuid,
                        riotId: currentUserData.fullRiotId,
                        lolRegion: currentUserData.lolRegion,
                        rank: currentUserData.rank,
                        queueType: dummyQueueType, // NEW: Pass dummy type
                        lane: dummyLane,           // NEW: Pass dummy lane
                        description: currentUserData.description // NEW: Pass description
                    })
                });
                const data = await response.json();

                if (response.ok) {
                    console.log("Start search response:", data.message);
                    showSection('searchSection');
                } else {
                    console.error('Error starting search:', data.error);
                    alert('Помилка при початку пошуку: ' + (data.error || 'Невідома помилка'));
                }

            } catch (err) {
                console.error('Start search network error:', err);
                alert('Помилка мережі при початку пошуку.');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            localStorage.removeItem('riotId');
            localStorage.removeItem('lolPlatformRegion');
            currentUserData = null;
            riotIdInput.value = '';
            lolPlatformRegionSelect.value = 'euw1';
            rememberMeCheckbox.checked = false;
            showSection('loginSection');
        });

        // ===============================================
        // Логіка Пошуку (Matchmaking)
        // ===============================================

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                currentActiveRegion = button.dataset.region;
                currentSearchRegionTitle.textContent = `Пошук на ${button.textContent}`;
                updateSearchQueueUI();
            });
        });

        stopSearchBtn.addEventListener('click', async () => {
            if (!currentUserData || !currentUserData.puuid) return;

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/stop-search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ puuid: currentUserData.puuid })
                });
                const data = await response.json();

                if (response.ok) {
                    console.log("Stopped search:", data.message);
                    showSection('dashboardSection');
                } else {
                    console.error('Error stopping search:', data.error);
                    alert('Помилка при зупинці пошуку: ' + (data.error || 'Невідома помилка'));
                }
            } catch (err) {
                console.error('Stop search network error:', err);
                alert('Помилка мережі при зупинці пошуку.');
            }
        });

        // Функція для оновлення UI черги
        async function updateSearchQueueUI() {
            if (!currentUserData) {
                searchQueueList.innerHTML = '<p>Поки що ніхто не шукає...</p>';
                currentUserInQueueCard.innerHTML = '<h3>Ви у черзі:</h3><p>Очікування...</p>';
                currentUserInQueueCard.style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/queue/${currentActiveRegion}`);
                const buddiesInQueue = await response.json();

                searchQueueList.innerHTML = ''; // Очищаємо список

                let userInQueueDisplayed = false;

                const currentUserInCurrentQueue = buddiesInQueue.find(buddy => buddy.puuid === currentUserData.puuid);

                if (currentUserInCurrentQueue) {
                    const userCard = createUserCard(currentUserInCurrentQueue, true);
                    currentUserInQueueCard.innerHTML = `<h3>Ви у черзі:</h3>` + userCard.outerHTML;
                    currentUserInQueueCard.style.display = 'block';
                    userInQueueDisplayed = true;
                } else {
                    currentUserInQueueCard.style.display = 'none';
                }

                if (buddiesInQueue.length === 0 && !userInQueueDisplayed) {
                    searchQueueList.innerHTML = '<p>Поки що ніхто не шукає...</p>';
                } else {
                    buddiesInQueue.forEach(buddy => {
                        if (buddy.puuid !== currentUserData.puuid) {
                            const userCard = createUserCard(buddy);
                            userCard.dataset.puuid = buddy.puuid; // Store PUUID on the card for click
                            searchQueueList.appendChild(userCard);
                        }
                    });

                    if (searchQueueList.children.length === 0 && !userInQueueDisplayed) {
                        searchQueueList.innerHTML = '<p>Поки що ніхто не шукає...</p>';
                    }
                }

                // NEW: Add event listeners to newly created user cards
                document.querySelectorAll('.user-card:not(.current-user-card)').forEach(card => {
                    card.addEventListener('click', () => {
                        const puuid = card.dataset.puuid;
                        if (puuid) {
                            openPlayerProfile(puuid);
                        }
                    });
                });

            } catch (error) {
                console.error("Error updating search queue UI:", error);
                searchQueueList.innerHTML = `<p class="error-message">Не вдалося завантажити список. Помилка: ${error.message}</p>`;
                currentUserInQueueCard.style.display = 'none';
            }
        }

        // Допоміжна функція для створення картки користувача (додаємо опис)
        function createUserCard(buddy, isCurrentUser = false) {
            const userCard = document.createElement('div');
            userCard.className = isCurrentUser ? 'user-card current-user-card' : 'user-card';
            userCard.id = `user-${buddy.puuid.replace(/[^a-zA-Z0-9]/g, '-')}`;
            userCard.innerHTML = `
                <h3>${buddy.riotId} (${buddy.lolRegion.toUpperCase()})</h3>
                <p class="user-details">Ранг: ${buddy.rank}</p>
                <p class="user-details">Черга: ${buddy.queueType || 'N/A'}</p>
                <p class="user-details">Позиція: ${buddy.lane || 'N/A'}</p>
                <p class="user-description-preview">${buddy.description ? buddy.description.substring(0, 50) + (buddy.description.length > 50 ? '...' : '') : 'Без опису'}</p>
            `;
            return userCard;
        }

        // ===============================================
        // NEW: Логіка Детального Профілю Гравця
        // ===============================================

        // Close button for the modal
        playerProfileCloseBtn.addEventListener('click', () => {
            playerProfileModal.style.display = 'none';
            // Optionally, return to the previous section (e.g., searchSection or dashboardSection)
            // based on where the user came from. For now, let's go back to searchSection.
            showSection('searchSection');
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === playerProfileModal) {
                playerProfileModal.style.display = 'none';
                showSection('searchSection');
            }
        });

        async function openPlayerProfile(puuid) {
            try {
                const response = await fetch(`${BACKEND_BASE_URL}/api/user/${puuid}`);
                const userData = await response.json();

                if (response.ok) {
                    playerProfileNickname.textContent = userData.fullRiotId;
                    playerProfileRank.textContent = userData.rank;
                    playerProfileServer.textContent = userData.lolRegion.toUpperCase();
                    playerProfileQueue.textContent = userData.currentQueueType || 'Не вказано'; // Use currentQueueType from full user data
                    playerProfileLane.textContent = userData.currentLane || 'Не вказано';       // Use currentLane from full user data
                    playerProfileDescription.textContent = userData.description || 'Опис відсутній.';

                    showSection('playerProfileModal'); // Show the modal
                    playerProfileModal.style.display = 'block'; // Ensure modal itself is block
                } else {
                    alert('Не вдалося завантажити профіль гравця: ' + (userData.error || 'Невідома помилка'));
                }
            } catch (error) {
                console.error('Error fetching player profile:', error);
                alert('Помилка мережі при завантаженні профілю гравця.');
            }
        }

    </script>
</body>
</html>